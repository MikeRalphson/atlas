<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">
 
  <bean id="contentUpdateTimerFactory" class="org.springframework.scheduling.timer.TimerFactoryBean">
    <property name="scheduledTimerTasks">
        <list>
            <ref bean="updateBbcBrandsScheduledTask" />
            <ref bean="updateItvBrandsScheduledTask" />
            <ref bean="updateHuluBrandsScheduledTask" />
            <ref bean="updatePlaylistsScheduledTask" />
            <ref bean="updateMentionsScheduledTask" />
            <!-- <ref bean="updateTVBlobScheduledTask" /> -->
        </list>
    </property>
    <property name="daemon" value="true" />
  </bean>
  
  	<bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
        <property name="triggers">
            <list>
                <ref bean="updateBbcSchedulesScheduledTask" />
                <ref bean="updateC4BrandsScheduledTask" />
            </list>
        </property>
    </bean>
	
	<bean id="updateBbcSchedulesScheduledTask" class="org.springframework.scheduling.quartz.CronTriggerBean">
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
                <property name="targetObject" ref="bbcSchedulesUpdate" />
                <property name="targetMethod" value="run" />
                <property name="concurrent" value="false" />
            </bean>
        </property>
          <!-- run every morning at 5 AM -->
        <property name="cronExpression" value="0 0 5 * * ?" />
    </bean>
    
    <bean id="updateC4BrandsScheduledTask" class="org.springframework.scheduling.quartz.CronTriggerBean">
         <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
                <property name="targetObject">
                    <bean parent="conditionalRunner">
                        <constructor-arg ref="c4BrandsUpdater" />
                     </bean>
                </property>
                <property name="targetMethod" value="run" />
                <property name="concurrent" value="false" />
            </bean>
        </property>
          <!-- run every morning at 5 AM -->
        <property name="cronExpression" value="0 0 5 * * ?" />
   </bean>
    
    <bean id="bbcSchedulesUpdate" parent="conditionalRunner">
   		<constructor-arg ref="bbcSchedulesUpdater"/>
   </bean>
  
   <bean id="updatePlaylistsScheduledTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="delay"  value="300000" />
    <property name="period" value="1800000" />
    <property name="runnable">
   		<bean parent="conditionalRunner">
    		<constructor-arg>
 					 <bean class="org.atlasapi.persistence.system.UriRefresher">
 					 	<property name="contentStore" ref="contentWriter"/>
                        <property name="fetcher" ref="remoteFetcher"/>
 					 	<property name="missingContentShouldBeMarkedAsUnavailable" value="false"/>
 					 	<property name="uris">
						  <list>
						      <value>http://feeds.bbc.co.uk/iplayer/highlights/tv</value>
						      <value>http://www.channel4.com/programmes/4od/highlights</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/most_viewed</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/top_rated</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/recently_featured</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/watch_on_mobile</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/most_discussed</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/top_favorites</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/most_responded</value>
                              <value>http://gdata.youtube.com/feeds/api/standardfeeds/most_recent</value>
						  </list>
					</property>
					</bean>
 			</constructor-arg>
 		</bean>
    </property>
  </bean>
  
  <bean id="updateMentionsScheduledTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="delay"  value="10000" />
    <property name="period" value="60000" />
    <property name="runnable">
        <bean parent="conditionalRunner">
            <constructor-arg>
                <bean class="org.atlasapi.tracking.PlaylistFromMentionsGenerator">
                   <constructor-arg ref="contentResolver"/>
                   <constructor-arg ref="contentWriter"/>
                   <constructor-arg ref="contentMentionStore"/>
                   <constructor-arg value="TWITTER"/>
               </bean>
            </constructor-arg>
        </bean>
    </property>
  </bean>
  
  <bean id="updateBbcBrandsScheduledTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="delay"  value="640000" />
    <property name="period" value="1800000" />
    <property name="runnable">
   		<bean parent="conditionalRunner">
    		<constructor-arg ref="bbcBrandsUpdater" />
 		</bean>
    </property>
  </bean>
  
  <bean id="updateItvBrandsScheduledTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="delay"  value="1340000" />
    <property name="period" value="1800000" />
    <property name="runnable">
   		<bean parent="conditionalRunner">
    		<constructor-arg ref="itvBrandsUpdater" />
 		</bean>
    </property>
  </bean>
  
  <bean id="updateHuluBrandsScheduledTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="delay"  value="1940000" />
    <property name="period" value="1800000" />
    <property name="runnable">
      <bean parent="conditionalRunner">
        <constructor-arg ref="huluBrandsUpdater" />
    </bean>
    </property>
  </bean>
  
  <bean id="updateTVBlobScheduledTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="delay"  value="2540000" />
    <property name="period" value="1800000" />
    <property name="runnable">
        <bean parent="conditionalRunner">
            <constructor-arg ref="tvblobUpdater" />
        </bean>
    </property>
  </bean>
  
  <bean id="brandsUpdater" abstract="true">
  	<property name="contentStore" ref="contentWriter"/>
	<property name="fetcher" ref="remoteFetcher"/>
	<property name="missingContentShouldBeMarkedAsUnavailable" value="true"/>
  </bean>
  
  <bean id="c4BrandsUpdater" class="org.atlasapi.persistence.system.UriRefresher" parent="brandsUpdater">
	 <property name="uris">
	 	<bean class="org.atlasapi.persistence.system.AToZUriSource">
	 		<constructor-arg value="http://www.channel4.com/programmes/atoz/"/>
	 		<constructor-arg value=""/>
	 		<constructor-arg value="true"/>
	 	</bean>
	 </property>
  </bean>
  
  <bean id="itvBrandsUpdater" class="org.atlasapi.persistence.system.UriRefresher" parent="brandsUpdater">
	 <property name="uri" value="http://www.itv.com/_data/xml/CatchUpData/CatchUp360/CatchUpMenu.xml" />
  </bean>
  
  <bean id="huluBrandsUpdater" class="org.atlasapi.persistence.system.UriRefresher" parent="brandsUpdater">
   <property name="uri" value="http://www.hulu.com/browse/alphabetical/episodes" />
  </bean>
  
  <bean id="bbcBrandsUpdater" class="org.atlasapi.persistence.system.UriRefresher" parent="brandsUpdater">
	 <property name="uris">
	 	<bean class="org.atlasapi.persistence.system.AToZUriSource">
	 		<constructor-arg value="http://feeds.bbc.co.uk/iplayer/atoz/"/>
	 		<constructor-arg value="/list"/>
	 		<constructor-arg value="true"/>
	 	</bean>
	 </property>
  </bean>
  
  <bean id="tvblobUpdater" class="org.atlasapi.remotesite.tvblob.TVBlobServicesUpdater">
    <constructor-arg ref="contentWriter"/>
    <constructor-arg ref="contentResolver" />
    <constructor-arg value="today" />
  </bean>
  
  <bean id="tvblobTomorrowUpdater" class="org.atlasapi.remotesite.tvblob.TVBlobServicesUpdater">
    <constructor-arg ref="contentWriter"/>
    <constructor-arg ref="contentResolver" />
    <constructor-arg value="tomorrow" />
  </bean>

  <bean id="bbcSchedulesUpdater" class="org.atlasapi.remotesite.bbc.schedule.BbcScheduledProgrammeUpdater">
	 <constructor-arg ref="contentResolver"/>
	 <property name="uris">
	    <bean class="org.atlasapi.remotesite.bbc.schedule.DatedBbcScheduleUriSource">
		    <property name="daysToLookAhead" value="5" />
	     </bean>
	  </property>
  </bean>    
  
  <bean id="perPublisherUpdater" class="org.atlasapi.remotesite.PerPublisherItemUpdater">
	 <constructor-arg ref="queryExecutor"/>
	 <constructor-arg>
		 <bean class="org.atlasapi.query.uri.canonical.CanonicalisingFetcher">
			<constructor-arg ref="savingFetcher" />
			<constructor-arg ref="aliasWriter" />
			<constructor-arg>
				<list>
	                <bean class="org.atlasapi.remotesite.youtube.YoutubeUriCanonicaliser"/>
				</list>
			</constructor-arg>
		</bean>
	 </constructor-arg>
	 <property name="uris">
	    <util:list>
	    	<value>vimeo.com</value>
	    	<value>ted.com</value>
	    	<value>youtube.com</value>
	    </util:list>
	  </property>
  </bean>   
  
  
  <bean id="manualUpdateMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="mappings">
            <props>
                <prop key="/system/c4/update">c4UpdateController</prop>
                <prop key="/system/bbc/update">bbcUpdateController</prop>
                <prop key="/system/bbc-schedule/update">bbcScheduleUpdateController</prop>
                <prop key="/system/orphans/update">orphanUpdateController</prop>
                <prop key="/system/hulu/update">huluUpdateController</prop>
                <prop key="/system/tvblob/update">tvblobUpdateController</prop>
                <prop key="/system/tvblob-tomorrow/update">tvblobTomorrowUpdateController</prop>
            </props>
        </property>
    </bean>
  
   <bean name="huluUpdateController" class="org.atlasapi.persistence.system.ContentUpdateController">
        <constructor-arg ref="huluBrandsUpdater"/>
   </bean>
   
    
    <bean id="c4UpdateController" class="org.atlasapi.persistence.system.ContentUpdateController">
        <constructor-arg ref="c4BrandsUpdater"/>
    </bean>
    
    <bean id="bbcUpdateController" class="org.atlasapi.persistence.system.ContentUpdateController">
        <constructor-arg ref="bbcBrandsUpdater"/>
    </bean>

    <bean id="bbcScheduleUpdateController" class="org.atlasapi.persistence.system.ContentUpdateController">
        <constructor-arg ref="bbcSchedulesUpdater"/>
    </bean>
    
    <bean id="tvblobUpdateController" class="org.atlasapi.persistence.system.ContentUpdateController">
        <constructor-arg ref="tvblobUpdater"/>
    </bean>
    
    <bean id="orphanUpdateController" class="org.atlasapi.persistence.system.ContentUpdateController">
        <constructor-arg ref="perPublisherUpdater"/>
    </bean>
  
  <bean id="conditionalRunner" abstract="true" class="com.metabroadcast.common.webapp.runnables.IpAddressBasedConditionalRunner">
  	<property name="shouldRunOnMachine" value="${scheduled.tasks.machine.ip}" />
  </bean>
   
</beans>
