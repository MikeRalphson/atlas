<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:util="http://www.springframework.org/schema/util" xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">

    <!--
  - Application context definition for URIplay. See uriplay-servlet.xml for webapp config.
  -->

    <import resource="classpath:beans-persistence.xml" />
    <import resource="classpath:beans-scheduling.xml" />
    <import resource="classpath:beans-short-url-services.xml" />
    <import resource="classpath:beans-tracking.xml" />
    <import resource="classpath:uriplay-servlet.xml" />

    <bean id="contextConfigurer" class="com.metabroadcast.common.webapp.properties.ContextConfigurer" init-method="init" />

    <bean id="localOrRemoteFetcher" class="org.uriplay.query.uri.canonical.CanonicalisingLocalRemoteFetcher">
        <constructor-arg>
            <bean class="org.uriplay.query.uri.LocalOrRemoteFetcher">
                <constructor-arg ref="mongoDbBackedContentStore" />
                <constructor-arg ref="savingFetcher" />
            </bean>
        </constructor-arg>
        <constructor-arg ref="contentStore" />
        <constructor-arg>
            <list>
                <bean class="org.uriplay.remotesite.bbc.BbcUriCanonicaliser" />
                <bean class="org.uriplay.remotesite.youtube.YoutubeUriCanonicaliser" />
                <bean class="org.uriplay.remotesite.ted.TedTalkAdapter.TedTalkCanonicaliser" />
                <bean class="org.uriplay.remotesite.dailymotion.DailyMotionItemAdapter.DailyMotionItemCanonicaliser" />
                <bean class="org.uriplay.remotesite.bliptv.BlipTvAdapter.BlipTvCanonicaliser" />
                <bean class="org.uriplay.remotesite.hulu.HuluAllBrandsAdapter.HuluAllBrandsCanonicaliser" />
                <bean class="org.uriplay.remotesite.hulu.HuluItemAdapter.HuluItemCanonicaliser" />
                <bean class="org.uriplay.remotesite.hulu.HuluBrandAdapter.HuluBrandCanonicaliser" />

                <!--  this should go last in the chain as it is an expensive operation -->
                <bean class="org.uriplay.remotesite.tinyurl.ShortenedUrlCanonicaliser">
                    <constructor-arg ref="urlShorteningServices" />
                </bean>
            </list>
        </constructor-arg>
    </bean>

    <bean id="titleSearcher" class="org.uriplay.query.content.fuzzy.InMemoryFuzzySearcher" />

    <bean id="AggregateContentListener" class="org.uriplay.persistence.content.QueueingContentListener" destroy-method="shutdown">
        <constructor-arg>
            <bean class="org.uriplay.persistence.content.AggregateContentListener">
                <constructor-arg>
                    <list>
                        <ref bean="titleSearcher" />
                    </list>
                </constructor-arg>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="savingFetcher" class="org.uriplay.query.uri.SavingFetcher">
        <constructor-arg ref="contentStore" />
        <constructor-arg ref="remoteFetcher" />
    </bean>

    <bean id="huluAllBrandsAdapter" class="org.uriplay.remotesite.hulu.HuluAllBrandsAdapter">
        <constructor-arg>
            <ref bean="huluBrandAdapter" />
        </constructor-arg>
        <property name="contentStore" ref="contentStore" />
    </bean>

    <bean id="huluBrandAdapter" class="org.uriplay.remotesite.hulu.HuluBrandAdapter">
        <property name="episodeAdapter">
            <bean class="org.uriplay.remotesite.hulu.HuluItemAdapter" />
        </property>
    </bean>

    <bean id="huluItemAdapter" class="org.uriplay.remotesite.hulu.HuluItemAdapter">
        <property name="contentStore" ref="contentStore" />
        <property name="brandAdapter" ref="huluBrandAdapter" />
    </bean>

    <bean id="remoteFetcher" class="org.uriplay.remotesite.PerSiteAdapterDispatcher">
        <property name="adapters">

            <!-- Adapters in this list are tried in order until one matches the fetched URI -->
            <list>
                <bean class="org.uriplay.remotesite.youtube.YouTubeAdapter" />
                <bean class="org.uriplay.remotesite.ted.TedTalkAdapter" />
                <bean class="org.uriplay.remotesite.channel4.C4AtomBackedBrandAdapter" />
                <bean class="org.uriplay.remotesite.channel4.C4HighlightsAdapter" />
                <bean class="org.uriplay.remotesite.channel4.C4BrandAtoZAdapter" />
                <bean class="org.uriplay.remotesite.dailymotion.DailyMotionItemAdapter" />
                <bean class="org.uriplay.remotesite.bliptv.BlipTvAdapter" />
                <bean class="org.uriplay.remotesite.itv.ItvBrandAdapter" />
                <bean class="org.uriplay.remotesite.bbc.BbcIplayerFeedAdapter" />
                <bean class="org.uriplay.remotesite.bbc.BbcProgrammeAdapter" />
                <bean class="org.uriplay.remotesite.bbc.BbcPodcastAdapter" />
                <ref bean="huluAllBrandsAdapter" />
                <ref bean="huluBrandAdapter" />
                <ref bean="huluItemAdapter" />
                <bean class="org.uriplay.remotesite.hulu.HuluRssAdapter" />

                <bean class="org.uriplay.remotesite.vimeo.VimeoAdapter">
                    <property name="acceptedUriPattern" value="http://vimeo.com/[\d]+" />
                    <property name="oembedEndpoint" value="http://www.vimeo.com/api/oembed.xml" />
                    <property name="maxWidth" value="400" />
                    <property name="publisher" value="vimeo.com" />
                </bean>
                <bean class="org.uriplay.remotesite.oembed.OembedXmlAdapter">
                    <property name="acceptedUriPattern" value="http://www.flickr.com/photos/[^/]+/[\d]+" />
                    <property name="oembedEndpoint" value="http://www.flickr.com/services/oembed/" />
                    <property name="publisher" value="flickr.com" />
                </bean>
                <bean class="org.uriplay.remotesite.synd.OpmlAdapter">
                    <constructor-arg ref="remoteFetcher" />
                </bean>
                <bean class="org.uriplay.remotesite.wikipedia.WikipediaSparqlAdapter" />
                <bean class="org.uriplay.remotesite.imdb.ImdbAdapter">
                    <constructor-arg ref="remoteFetcher" />
                </bean>
            </list>
        </property>
    </bean>

    <util:properties id="rdfNsPrefixes">
        <prop key="http://uriplay.org/elements/">play</prop>
        <prop key="http://www.w3.org/1999/02/22-rdf-syntax-ns#">rdf</prop>
        <prop key="http://www.w3.org/2000/01/rdf-schema#">rdfs</prop>
        <prop key="http://purl.org/dc/elements/1.1/">dc</prop>
        <prop key="http://purl.org/ontology/po/">po</prop>
        <prop key="http://xmlns.com/foaf/0.1/">foaf</prop>
        <prop key="http://rdfs.org/sioc/ns#">sioc</prop>
        <prop key="http://purl.org/dc/terms/">dcterms</prop>
    </util:properties>

    <bean id="rdfXmlTranslator" class="org.uriplay.rdf.beans.RdfXmlTranslator">
        <constructor-arg>
            <bean class="org.uriplay.beans.NaiveTypeMap" />
        </constructor-arg>
        <property name="nsPrefixes" ref="rdfNsPrefixes" />
    </bean>

</beans>
